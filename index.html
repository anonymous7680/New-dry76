<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dry.Coffee76 – Boutique</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg:#121212;
      --surface:#1e1e1e;
      --text:#e0e0e0;
      --accent:#ff6d00;     /* Orange vif */
      --accent-light:#ff8a50;
      --border:#333;
    }

    body {
      margin:0;padding:0;
      background:var(--bg);color:var(--text);
      font-family:Arial,Helvetica,sans-serif;
    }

    header {
      background:var(--surface);padding:1rem;
      text-align:center;position:relative;
      border-bottom:1px solid var(--border);
    }
    .back-btn {
      position:absolute;left:1rem;top:50%;transform:translateY(-50%);
      background:none;border:none;color:var(--text);font-size:1.5rem;cursor:pointer;
    }

    .container {max-width:480px;margin:auto;padding:1rem;}

    /* === PAGE LISTE === */
    #listPage .grid {
      display:grid;grid-template-columns:1fr 1fr;gap:1rem;
    }
    .card {
      background:var(--surface);border-radius:12px;overflow:hidden;
      cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.3);
      text-align:center;transition:transform .2s;
    }
    .card:hover {transform:scale(1.03);}
    .card img {width:100%;height:130px;object-fit:cover;}
    .card h3 {margin:0.5rem 0.5rem 0.3rem;font-size:1rem;color:var(--accent);}
    .card .price {font-weight:bold;color:#ffab40;margin:0 0.5rem 0.5rem;}

    /* === PAGE DÉTAIL === */
    #detailPage {display:none;}
    .media-wrapper {
      position:relative;width:100%;height:220px;margin-bottom:1rem;
      border-radius:12px;overflow:hidden;cursor:pointer;
    }
    .media-wrapper img, .media-wrapper video {
      width:100%;height:100%;object-fit:cover;
    }
    .play-icon {
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      font-size:3rem;color:#fff;opacity:0.8;pointer-events:none;
    }
    .detail-desc {font-size:0.95rem;line-height:1.5;margin:1rem 0;color:#ccc;}
    .detail-price {font-size:1.3rem;font-weight:bold;color:var(--accent-light);margin:0.5rem 0;}
    .add-detail {
      background:var(--accent);color:#fff;border:none;padding:0.8rem;
      border-radius:8px;font-size:1.1rem;cursor:pointer;width:100%;
    }

    /* === PANIER === */
    #cart {
      margin-top:1.5rem;padding:1rem;background:var(--surface);
      border-radius:12px;border:1px solid var(--border);
    }
    #cart ul {list-style:none;padding:0;margin:0;}
    #cart li {
      display:flex;justify-content:space-between;padding:.4rem 0;
      border-bottom:1px solid var(--border);color:#ccc;
    }
    #cart .total {font-weight:bold;margin-top:.5rem;color:var(--accent-light);}
    #checkoutBtn {
      width:100%;margin-top:1rem;padding:.8rem;
      background:var(--accent-light);color:#000;border:none;
      border-radius:8px;font-size:1.1rem;cursor:pointer;
    }
    #checkoutBtn:disabled {background:#444;color:#777;cursor:not-allowed;}
  </style>
</head>
<body>
  <!-- === PAGE LISTE === -->
  <div id="listPage">
    <header>
      <h1>Dry.Coffee76</h1>
      <p>Produits naturels – 2 par ligne</p>
    </header>
    <div class="container">
      <div class="grid" id="productsGrid"></div>
    </div>
  </div>

  <!-- === PAGE DÉTAIL === -->
  <div id="detailPage">
    <header>
      <button class="back-btn" id="backBtn">Back</button>
      <h1 id="detailTitle"></h1>
    </header>
    <div class="container">
      <div class="media-wrapper" id="mediaWrapper">
        <img id="detailImg" alt="">
        <video id="detailVideo" preload="none" loop muted playsinline></video>
        <div class="play-icon">Play</div>
      </div>
      <p class="detail-desc" id="detailDesc"></p>
      <p class="detail-price" id="detailPrice"></p>
      <button class="add-detail" id="addDetailBtn">Ajouter au panier</button>
    </div>
  </div>

  <!-- === PANIER === -->
  <div class="container" id="cart">
    <h2>Panier</h2>
    <ul id="cartItems"></ul>
    <div class="total" id="totalPrice">Total : 0 €</div>
    <button id="checkoutBtn" disabled>Valider la commande</button>
  </div>

  <script>
    // ========================================
    // 1. Telegram WebApp
    // ========================================
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // ========================================
    // 2. Catalogue (SANS CBD)
    // ========================================
    const catalogue = [
      {
        id: 1,
        name: "Huile 10 %",
        desc: "Huile sublinguale full‑spectrum, 10 % extrait, 10 ml. Idéale pour la détente quotidienne. Effet relaxant, sans psychoactivité.",
        price: 29.90,
        img: "https://images.unsplash.com/photo-1635321593232-297c6dd0fc76?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
        video: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
      },
      {
        id: 2,
        name: "Fleurs Amnesia",
        desc: "Fleurs séchées premium, THC < 0,2 %. Arôme citronné intense, effet relaxant. Parfait en infusion ou vaporisation.",
        price: 8.50,
        unit: "g",
        img: "https://images.unsplash.com/photo-1628771065518-0d82f1938462?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
        video: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4"
      },
      {
        id: 3,
        name: "Gélules 25 mg",
        desc: "Boîte de 30 gélules, 25 mg extrait chacune. Dosage précis, absorption lente. Idéal pour un usage régulier.",
        price: 34.00,
        img: "https://images.unsplash.com/photo-1584308661627-7892d85ac4c8?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
        video: "https:// |commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4"
      },
      {
        id: 4,
        name: "Résine Hash 20 %",
        desc: "Résine pressée à froid, 20 % extrait. Texture souple, goût boisé. À effriter dans une infusion ou un vaporisateur.",
        price: 12.00,
        unit: "g",
        img: "https://images.unsplash.com/photo-1633356122102-3fe601e05bd2?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
        video: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4"
      }
    ];

    // ========================================
    // 3. Panier
    // ========================================
    let cart = [];
    let currentProduct = null;

    // ========================================
    // 4. Grille 2 colonnes
    // ========================================
    const grid = document.getElementById('productsGrid');
    catalogue.forEach(p => {
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.id = p.id;
      card.innerHTML = `
        <img src="${p.img}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p class="price">${p.price.toFixed(2)} € ${p.unit ? `/ ${p.unit}` : ''}</p>
      `;
      grid.appendChild(card);
    });

    // ========================================
    // 5. Clic → Détail
    // ========================================
    grid.addEventListener('click', e => {
      const card = e.target.closest('.card');
      if (!card) return;
      const id = Number(card.dataset.id);
      currentProduct = catalogue.find(p => p.id === id);

      document.getElementById('detailTitle').textContent = currentProduct.name;
      document.getElementById('detailImg').src = currentProduct.img;
      document.getElementById('detailVideo').src = currentProduct.video;
      document.getElementById('detailDesc').textContent = currentProduct.desc;
      document.getElementById('detailPrice').textContent = 
        `${currentProduct.price.toFixed(2)} € ${currentProduct.unit ? `/ ${currentProduct.unit}` : ''}`;

      // Reset média
      const video = document.getElementById('detailVideo');
      video.pause();
      video.style.display = 'none';
      document.getElementById('detailImg').style.display = 'block';
      document.querySelector('#mediaWrapper .play-icon').style.display = 'block';

      // Switch page
      document.getElementById('listPage').style.display = 'none';
      document.getElementById('detailPage').style.display = 'block';
      tg.MainButton.hide();
    });

    // Retour
    document.getElementById('backBtn').addEventListener('click', () => {
      document.getElementById('detailPage').style.display = 'none';
      document.getElementById('listPage').style.display = 'block';
      tg.MainButton.show();
    });

    // ========================================
    // 6. Image ↔ Vidéo
    // ========================================
    document.getElementById('mediaWrapper').addEventListener('click', () => {
      const img = document.getElementById('detailImg');
      const video = document.getElementById('detailVideo');
      const icon = document.querySelector('#mediaWrapper .play-icon');

      if (img.style.display !== 'none') {
        img.style.display = 'none';
        video.style.display = 'block';
        icon.style.display = 'none';
        video.play().catch(() => {});
      } else {
        video.pause();
        video.currentTime = 0;
        video.style.display = 'none';
        img.style.display = 'block';
        icon.style.display = 'block';
      }
    });

    // ========================================
    // 7. Ajouter au panier
    // ========================================
    document.getElementById('addDetailBtn').addEventListener('click', () => {
      if (!currentProduct) return;
      const existing = cart.find(i => i.id === currentProduct.id);
      if (existing) existing.qty++;
      else cart.push({id: currentProduct.id, name: currentProduct.name, price: currentProduct.price, qty: 1, unit: currentProduct.unit});
      updateCartUI();
      tg.HapticFeedback.impactOccurred('light');
    });

    // ========================================
    // 8. Panier UI
    // ========================================
    function updateCartUI() {
      const itemsEl = document.getElementById('cartItems');
      itemsEl.innerHTML = '';
      let total = 0;

      cart.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${item.qty} × ${item.name}</span><span>${(item.price * item.qty).toFixed(2)} €</span>`;
        itemsEl.appendChild(li);
        total += item.price * item.qty;
      });

      document.getElementById('totalPrice').textContent = `Total : ${total.toFixed(2)} €`;
      document.getElementById('checkoutBtn').disabled = cart.length === 0;
    }

    // ========================================
    // 9. Valider commande
    // ========================================
    document.getElementById('checkoutBtn').addEventListener('click', () => {
      if (cart.length === 0) return;

      const order = {
        items: cart.map(i => ({
          name: i.name,
          qty: i.qty,
          price: i.price,
          unit: i.unit || null
        })),
        total: cart.reduce((s, i) => s + i.price * i.qty, 0).toFixed(2)
      };

      tg.sendData(JSON.stringify(order));
      tg.MainButton.setText('Commande envoyée !').show();
      setTimeout(() => tg.close(), 1500);
    });

    // ========================================
    // 10. Bouton principal
    // ========================================
    tg.MainButton.setText('Voir le panier')
                .onClick(() => document.getElementById('cart').scrollIntoView({behavior:'smooth'}))
                .show();

    updateCartUI();
  </script>
</body>
</html>
